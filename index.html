<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Чат с логином</title>
<style>
body { font-family: Arial; display:flex; justify-content:center; padding-top:30px; background:#f0f2f5;}
#loginDiv, #chatDiv { width:400px; background:white; border-radius:10px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
#chat { border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px; margin-bottom:10px; border-radius:5px; background:#fafafa;}
input, button { padding:5px; margin-bottom:5px; border-radius:5px; border:1px solid #ccc; width:100%;}
.message { margin:5px 0; }
.message span { font-weight:bold; margin-right:5px; }
button.delete { margin-left:5px; padding:2px 5px; font-size:12px; }
#contacts p { margin:2px 0; }
</style>
</head>
<body>

<div id="loginDiv">
  <h2>Вход / Регистрация</h2>
  <input id="username" placeholder="Логин"><br>
  <input id="password" type="password" placeholder="Пароль"><br>
  <button onclick="register()">Регистрация</button>
  <button onclick="login()">Войти</button>
  <p id="loginMsg"></p>
</div>

<div id="chatDiv" style="display:none;">
  <h2>Чат</h2>
  <h3>Контакты</h3>
  <div id="contacts"></div>
  <div id="chat"></div>
  <input id="msg" placeholder="Введите сообщение">
  <button onclick="sendMessage()">Отправить</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// Локальные данные для демонстрации
let users = []; // зарегистрированные пользователи {username, password}
let contacts = [];
let currentUser = null;
let chatHistory = [];

function register(){
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!username || !password) return alert("Введите логин и пароль");
    if(users.find(u=>u.username===username)) return alert("Пользователь уже существует");
    users.push({username,password});
    contacts.push(username);
    alert("Регистрация успешна");
}

function login(){
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const user = users.find(u=>u.username===username && u.password===password);
    if(!user) return alert("Неверный логин или пароль");
    currentUser = username;
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('chatDiv').style.display='block';
    initChat();
    showContacts();
}

// Отображение контактов
function showContacts(){
    const contactsDiv = document.getElementById('contacts');
    contactsDiv.innerHTML = contacts.map(c=>`<p>${c}</p>`).join('');
}

// Инициализация чата
let socket = null;
function initChat(){
    socket = io('https://c64b8f1b-caab-4249-9258-f0cb9ac11ecb-00-3tv4oshnskwz2.janeway.replit.dev');
    socket.username = currentUser;

    const chatDivEl = document.getElementById('chat');

    function addMessage(data){
        const p = document.createElement('div');
        p.classList.add('message');
        p.id = data.id;
        p.innerHTML = `<span>${data.user}:</span> ${data.msg}`;
        if(data.user === currentUser){
            const delBtn = document.createElement('button');
            delBtn.textContent = "Удалить";
            delBtn.classList.add('delete');
            delBtn.onclick = ()=> socket.emit('delete message', data.id);
            p.appendChild(delBtn);
        }
        chatDivEl.appendChild(p);
        chatDivEl.scrollTop = chatDivEl.scrollHeight;
    }

    // История сообщений
    socket.on("chat history", history => history.forEach(addMessage));
    socket.on("chat message", addMessage);
    socket.on("delete message", id => {
        const el = document.getElementById(id);
        if(el) el.remove();
    });
}

// Отправка сообщений
function sendMessage(){
    const msgInput = document.getElementById('msg');
    const msg = msgInput.value.trim();
    if(!msg) return;
    const data = { id: Date.now()+"_"+Math.random().toString(36).substr(2,5), user: currentUser, msg };
    chatHistory.push(data);
    socket.emit('chat message', data);
    msgInput.value='';
}
</script>
</body>
</html>
